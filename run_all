#!/usr/bin/env python3
"""
ä¸€é”®å¯åŠ¨è®­ç»ƒ + Streamlit å®æ—¶ç›‘æ§ Dashboard
é€‚é…ä½ çš„è·¯å¾„ï¼šE:\LLM&agentTest\CTO
"""

import subprocess
import time
import webbrowser
import threading
import os
from pathlib import Path


# ============ é…ç½® ============

ROOT_DIR = r"E:\\LLM&agentTest\\CTO"

# è®­ç»ƒè„šæœ¬è·¯å¾„
AGENT_SCRIPT = os.path.join(ROOT_DIR, "agent.py")

# Streamlit Dashboard è·¯å¾„
DASHBOARD_SCRIPT = os.path.join(ROOT_DIR, "dashboard.py")

# å·¥ä½œç›®å½•ï¼ˆå’Œ agent.py çš„ work-root ä¿æŒä¸€è‡´ï¼‰
WORK_ROOT = os.path.join(ROOT_DIR, "my_custom_work")

# æ˜¯å¦è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
AUTO_OPEN_BROWSER = True



# ============ å¯åŠ¨è®­ç»ƒ ============

def start_training():
    print("ğŸš€ å¯åŠ¨è®­ç»ƒè„šæœ¬ agent.py ...")

    cmd = ["python", AGENT_SCRIPT]

    # ç¡®ä¿åœ¨è®­ç»ƒç›®å½•å¯åŠ¨
    process = subprocess.Popen(
        cmd,
        cwd=ROOT_DIR,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        bufsize=1,
    )

    def reader_thread():
        for line in process.stdout:
            print("ã€è®­ç»ƒæ—¥å¿—ã€‘", line, end="")

    threading.Thread(target=reader_thread, daemon=True).start()
    return process



# ============ å¯åŠ¨ Dashboard ============

def start_dashboard():
    print("ğŸ“Š å¯åŠ¨ Streamlit Dashboard ...")

    cmd = [
        "streamlit",
        "run",
        DASHBOARD_SCRIPT,
        "--",
        "--work-root",
        WORK_ROOT
    ]

    process = subprocess.Popen(
        cmd,
        cwd=ROOT_DIR,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        bufsize=1,
    )

    def reader_thread():
        for line in process.stdout:
            print("ã€Dashboardã€‘", line, end="")

    threading.Thread(target=reader_thread, daemon=True).start()
    return process



# ============ è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ ============

def open_browser_later():
    time.sleep(5)
    url = "http://localhost:8501"
    print(f"ğŸŒ æ‰“å¼€æµè§ˆå™¨: {url}")
    webbrowser.open(url)



# ============ ä¸»å…¥å£ ============

def main():

    print("========================================")
    print("ğŸ“¢ ä¸€é”®å¯åŠ¨ï¼šè®­ç»ƒ + å®æ—¶å¯è§†åŒ–ç›‘æ§")
    print("========================================")

    # åˆ›å»ºå·¥ä½œç›®å½•
    if not Path(WORK_ROOT).exists():
        print(f"âš ï¸ å·¥ä½œç›®å½•ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º: {WORK_ROOT}")
        Path(WORK_ROOT).mkdir(parents=True, exist_ok=True)

    # 1. å¯åŠ¨è®­ç»ƒ
    train_proc = start_training()

    # 2. å¯åŠ¨ Dashboard
    dash_proc = start_dashboard()

    # 3. è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
    if AUTO_OPEN_BROWSER:
        threading.Thread(target=open_browser_later, daemon=True).start()

    print("\nâ³ è®­ç»ƒè¿›è¡Œä¸­ï¼Œdashboard æ­£åœ¨æ˜¾ç¤ºå®æ—¶çŠ¶æ€ ...\n")

    # ç­‰è®­ç»ƒç»“æŸ
    train_proc.wait()

    print("\nâœ… è®­ç»ƒç»“æŸï¼ä½ ä»å¯ç»§ç»­æŸ¥çœ‹ Dashboard é¡µé¢ã€‚")



if __name__ == "__main__":
    main()
