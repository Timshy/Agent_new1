# Agent.py å‡çº§å˜æ›´æ—¥å¿—

## ç‰ˆæœ¬ä¿¡æ¯
- **å‡çº§æ—¥æœŸ**: 2024
- **å‡çº§ç±»å‹**: æ ¸å¿ƒé€»è¾‘é‡æ„
- **å½±å“èŒƒå›´**: æŠ½æ ·ç­–ç•¥ã€è¯„åˆ†ç³»ç»Ÿã€è®­ç»ƒæµç¨‹

---

## é‡å¤§å˜æ›´æ‘˜è¦

### âœ… å˜æ›´1ï¼šå›ºå®šæ¯è½®æŠ½æ ·æ•°ï¼ˆ30å¼ ï¼‰

#### æ—§ç‰ˆæœ¬
```python
# æŒ‰æ¯”ä¾‹æŠ½æ ·ï¼ˆé»˜è®¤20%ï¼‰
sample_size = max(1, int(len(available_images) * args.sample_ratio))
sampled_images = random.sample(available_images, min(sample_size, len(available_images)))
print(f"[æŠ½æ ·] æœ¬è½®æŠ½å–: {len(sampled_images)} å¼ ï¼ˆ{args.sample_ratio:.1%}ï¼‰")
```

#### æ–°ç‰ˆæœ¬
```python
# å›ºå®šæ•°é‡æŠ½æ ·ï¼ˆé»˜è®¤30å¼ ï¼‰
random.seed(round_num)  # ä¿è¯å¯å¤ç°
sample_size = min(args.samples_per_round, len(available_images))
sampled_images = random.sample(available_images, sample_size)
print(f"[æŠ½æ ·] æœ¬è½®æŠ½å–: {len(sampled_images)} å¼ ï¼ˆå›ºå®š={args.samples_per_round}ï¼‰")
```

**å½±å“**ï¼š
- å‘½ä»¤è¡Œå‚æ•°ï¼š`--sample-ratio` â†’ `--samples-per-round`
- é»˜è®¤å€¼ï¼š`0.2` (20%) â†’ `30` (å›ºå®šæ•°é‡)
- æ¯è½®APIè°ƒç”¨æˆæœ¬ï¼šåŠ¨æ€å˜åŒ– â†’ å›ºå®šæœ€å¤š30æ¬¡
- å¯å¤ç°æ€§ï¼šéœ€æ‰‹åŠ¨è®¾ç½®ç§å­ â†’ è‡ªåŠ¨è®¾ç½® `random.seed(round_num)`

---

### âœ… å˜æ›´2ï¼šæä¸¥è‹›è¯„åˆ†Promptï¼ˆ0-100 â†’ 0.0-10.0ï¼‰

#### æ—§ç‰ˆæœ¬
```python
SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªåŒ»å­¦å›¾åƒåˆ†å‰²è´¨é‡å®¡æŸ¥å®˜ï¼Œå¿…é¡»ä¸¥æ ¼è¯„ä¼°é¢„æµ‹æ©ç è´¨é‡ã€‚

è¾“å‡ºè¦æ±‚ï¼š
1. è¯„ä¼°é¢„æµ‹æ©ç çš„è¾¹ç•Œç²¾åº¦ã€ç›®æ ‡å®Œæ•´æ€§ã€æ— å…³åŒºåŸŸ
2. ç»™å‡º 0~100 åˆ†ï¼ˆ90-100=ä¼˜ç§€ï¼Œ70-89=è‰¯å¥½ï¼Œ50-69=ä¸­ç­‰ï¼Œ<50=è¾ƒå·®ï¼‰
3. **å¿…é¡»è¾“å‡ºä¸¥æ ¼ JSON æ ¼å¼**ï¼š{"overall_score": 85.5, "reason": "è¾¹ç•Œæ¸…æ™°ï¼Œè¦†ç›–å®Œæ•´"}

è¯„åˆ†æ ‡å‡†ï¼š
- å®Œå…¨æ­£ç¡®æˆ–å‡ ä¹ä¸€è‡´ â†’ 90-100
- è¾ƒå¥½ä½†æœ‰å°‘é‡åå·® â†’ 70-89
- ä¸­ç­‰è´¨é‡ï¼ˆæœ‰æ¼æ£€æˆ–è¯¯æ£€ï¼‰ â†’ 50-69
- ä¸¥é‡é—®é¢˜ â†’ 10-49
- å®Œå…¨é”™è¯¯ â†’ 0-9
"""
```

#### æ–°ç‰ˆæœ¬
```python
SYSTEM_PROMPT = """ä½ æ˜¯é¡¶å°–åŒ»å­¦å›¾åƒåˆ†å‰²è´¨æ£€AIï¼Œä»»åŠ¡æ˜¯å¯¹é¢„æµ‹æ©ç è¿›è¡Œ **0.0â€“10.0 è¯„åˆ†ï¼ˆä¿ç•™1ä½å°æ•°ï¼Œç¦æ­¢ç»™ 9.0 åŠä»¥ä¸Šï¼‰**ã€‚

ã€è¾“å…¥å›¾åƒã€‘
- å·¦ä¾§ï¼šåŸå§‹åŒ»å­¦å›¾åƒ
- å³ä¾§ï¼šæ¨¡å‹é¢„æµ‹çš„äºŒå€¼æ©ç ï¼ˆç™½è‰²=å‰æ™¯ï¼‰

ã€æ‰£åˆ†ç»†åˆ™ã€‘ï¼ˆå¿…é¡»é€é¡¹æ£€æŸ¥ï¼Œé›¶å®¹å¿ï¼‰
1. **è¾¹ç•Œè¯¯å·®**ï¼ˆæƒé‡50%ï¼‰ï¼šä»»æ„ä½ç½®è¾¹ç•Œåå·® >1px æ‰£1.0åˆ†ï¼Œ>3px æ‰£2.5åˆ†ï¼Œå­˜åœ¨é”¯é½¿/æ¯›åˆº æ‰£1.5åˆ†
2. **æ¬ åˆ†å‰²**ï¼ˆæƒé‡25%ï¼‰ï¼šé—æ¼çœŸå®ç»“æ„ >5% æ‰£2.0åˆ†ï¼Œ>10% æ‰£4.0åˆ†
3. **è¿‡åˆ†å‰²**ï¼ˆæƒé‡15%ï¼‰ï¼šå‡é˜³æ€§åŒºåŸŸ >3% æ‰£1.5åˆ†ï¼Œ>8% æ‰£3.0åˆ†
4. **ç©ºæ´/å™ªç‚¹**ï¼ˆæƒé‡10%ï¼‰ï¼šå‰æ™¯å†…ç©ºæ´ >3px æ‰£1.0åˆ†ï¼Œå­¤ç«‹å™ªç‚¹ >5ä¸ª æ‰£0.8åˆ†

ã€è¾“å‡ºè¦æ±‚ã€‘
- å¿…é¡»è¿”å› **çº¯ JSON**ï¼š{"overall_score": 7.6, "reason": "è¾¹ç•Œè½»å¾®é”¯é½¿ï¼Œæ¬ åˆ†å‰²çº¦6%"}
- æœ€é«˜åˆ† 8.9ï¼Œå®Œç¾åˆ†å‰²ç»™ 8.7â€“8.9
- reason æ§åˆ¶åœ¨ 12å­—ä»¥å†…
- æ¸©åº¦ temperature=0.0ï¼Œç¡®ä¿ç¡®å®šæ€§
"""
```

**å½±å“**ï¼š
- è¯„åˆ†èŒƒå›´ï¼š0-100 â†’ 0.0-10.0
- æœ€é«˜åˆ†ï¼š100 â†’ 8.9ï¼ˆç¦æ­¢9.0åŠä»¥ä¸Šï¼‰
- è¯„åˆ†ç­–ç•¥ï¼šç›¸å¯¹å®½æ¾ â†’ æä¸¥è‹›ï¼ˆé›¶å®¹å¿æ‰£åˆ†ï¼‰
- ç¡®å®šæ€§ï¼š`temperature=0.3` â†’ `temperature=0.0`
- é«˜ç½®ä¿¡é˜ˆå€¼ï¼š`--high-confidence 80.0` â†’ `--high-confidence 7.5`

**é˜ˆå€¼å¯¹ç…§è¡¨**ï¼š
| æ—§ç‰ˆæœ¬(0-100) | æ–°ç‰ˆæœ¬(0-10) | è´¨é‡ç­‰çº§ |
|--------------|-------------|---------|
| 90-100       | 8.7-8.9     | å®Œç¾    |
| 80-89        | 7.5-8.6     | ä¼˜ç§€    |
| 70-79        | 6.5-7.4     | è‰¯å¥½    |
| 60-69        | 5.5-6.4     | ä¸­ç­‰    |
| <60          | <5.5        | è¾ƒå·®    |

---

### âœ… å˜æ›´3ï¼šçƒ­å¯åŠ¨è®­ç»ƒ + å­¦ä¹ ç‡é€’å‡

#### æ—§ç‰ˆæœ¬
```python
def train_unet(...):
    # æ¯è½®ä»å¤´è®­ç»ƒï¼Œå­¦ä¹ ç‡å›ºå®š
    cmd = [
        "python", str(unet_script),
        f"--lr={args.lr}",  # å›ºå®šå­¦ä¹ ç‡
        ...
    ]
```

#### æ–°ç‰ˆæœ¬
```python
def train_unet(..., pretrained_model: Optional[Path] = None):
    # å­¦ä¹ ç‡é€’å‡ç­–ç•¥
    lr = args.lr * (0.8 ** round_num)
    
    cmd = [
        "python", str(unet_script),
        f"--lr={lr}",  # åŠ¨æ€å­¦ä¹ ç‡
        ...
    ]
    
    # çƒ­å¯åŠ¨ï¼šä»é¢„è®­ç»ƒæ¨¡å‹ç»§ç»­
    if pretrained_model and pretrained_model.exists():
        cmd.append(f"--pretrained_model={pretrained_model}")
        print(f"[è®­ç»ƒ] Round {round_num} çƒ­å¯åŠ¨ï¼š{pretrained_model}")
```

**è°ƒç”¨ä¾§**ï¼š
```python
# çƒ­å¯åŠ¨ï¼šä»ä¸Šä¸€è½®æœ€ä½³æ¨¡å‹ç»§ç»­
pretrained = work_root / "best_model.pth" if (work_root / "best_model.pth").exists() else best_model_path

success, metrics = train_unet(
    ...,
    pretrained_model=pretrained  # æ–°å¢å‚æ•°
)
```

**å½±å“**ï¼š
- è®­ç»ƒç­–ç•¥ï¼šæ¯è½®ä»å¤´è®­ç»ƒ â†’ çƒ­å¯åŠ¨å¾®è°ƒ
- å­¦ä¹ ç‡ï¼šå›ºå®š â†’ æŒ‡æ•°é€’å‡ï¼ˆ0.8^roundï¼‰
- æ”¶æ•›é€Ÿåº¦ï¼šæ…¢ â†’ å¿«
- **é‡è¦**ï¼šéœ€è¦ unet è„šæœ¬æ”¯æŒ `--pretrained_model` å‚æ•°

---

### âœ… å˜æ›´4ï¼šé«˜åˆ†æ ·æœ¬å®¡è®¡æœºåˆ¶

#### æ–°å¢åŠŸèƒ½
```python
def batch_evaluate_with_kimi(..., suspicious_root: Optional[Path] = None):
    # æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿å­˜å¯ç–‘é«˜åˆ†æ ·æœ¬
    if suspicious_dir and result["overall_score"] >= 9.0:
        timestamp = int(time.time() * 1000)
        suspicious_name = f"suspicious_{timestamp}_{img_name}"
        
        shutil.copy(img_path, suspicious_dir / "images" / suspicious_name)
        shutil.copy(pred_path, suspicious_dir / "pred_masks" / suspicious_name)
        
        print(f"\n[å®¡è®¡] å‘ç°å¯ç–‘é«˜åˆ†æ ·æœ¬ ({result['overall_score']:.1f}): {img_name}")
```

**å½±å“**ï¼š
- æ–°å¢å‚æ•°ï¼š`--suspicious-root`
- è§¦å‘æ¡ä»¶ï¼šåˆ†æ•° >= 9.0ï¼ˆç†è®ºä¸Šä¸åº”å‡ºç°ï¼‰
- è¾“å‡ºç›®å½•ï¼š`suspicious_score_10/images/` å’Œ `suspicious_score_10/pred_masks/`
- ç”¨é€”ï¼šäººå·¥å¤æ ¸å¼‚å¸¸é«˜åˆ†æ ·æœ¬

---

### âœ… å˜æ›´5ï¼šå¢å¼ºæ—¥å¿—å­—æ®µ

#### æ—§ç‰ˆæœ¬
```json
{
  "round": 1,
  "sampled": 20,
  "selected": 12,
  "avg_confidence": 75.3,
  "pseudo_total": 120,
  "dice": 0.8532
}
```

#### æ–°ç‰ˆæœ¬
```json
{
  "round": 1,
  "sampled_count": 30,              // æ˜ç¡®å­—æ®µå
  "selected": 14,
  "avg_score_this_round": 7.6,      // æœ¬è½®å¹³å‡åˆ†
  "high_confidence_rate": 0.4667,   // å…¥é€‰ç‡ï¼ˆ14/30ï¼‰
  "pseudo_total": 120,
  "dice": 0.8532,
  "precision": 0.8912,
  "recall": 0.8201,
  "f1": 0.8541
}
```

**æ–°å¢å­—æ®µ**ï¼š
- `sampled_count`: æœ¬è½®æŠ½æ ·æ•°é‡ï¼ˆæ›¿ä»£ `sampled`ï¼‰
- `avg_score_this_round`: æœ¬è½®å¹³å‡è¯„åˆ†ï¼ˆæ›¿ä»£ `avg_confidence`ï¼‰
- `high_confidence_rate`: é«˜ç½®ä¿¡ç‡ = selected / sampled_count

---

## å…¼å®¹æ€§è¯´æ˜

### âš ï¸ ç ´åæ€§å˜æ›´ï¼ˆä¸å…¼å®¹ï¼‰

1. **å‘½ä»¤è¡Œå‚æ•°**ï¼š
   - `--sample-ratio` å·²ç§»é™¤ â†’ ä½¿ç”¨ `--samples-per-round`
   - `--high-confidence` æ•°å€¼èŒƒå›´å˜åŒ–ï¼š0-100 â†’ 0-10

2. **è¯„åˆ†ç³»ç»Ÿ**ï¼š
   - æ‰€æœ‰è¯„åˆ†ç»“æœä» 0-100 æ”¹ä¸º 0.0-10.0
   - æ—§ç‰ˆæœ¬çš„å¤‡ä»½æ•°æ®ï¼ˆ`backup/*/scores.json`ï¼‰ä¸å…¼å®¹

3. **çƒ­å¯åŠ¨è®­ç»ƒ**ï¼š
   - éœ€è¦ unet è„šæœ¬æ”¯æŒ `--pretrained_model` å‚æ•°
   - å¦‚æœ unet ä¸æ”¯æŒï¼Œæ¯è½®ä»ä¼šä»å¤´è®­ç»ƒï¼ˆä½†ä¸å½±å“è¿è¡Œï¼‰

### âœ… å‘åå…¼å®¹

1. **æ–‡ä»¶ç»“æ„**ï¼š
   - ä¼ªæ ‡ç­¾é›†ç›®å½•ç»“æ„ä¸å˜ï¼ˆ`pseudo_labels/images/`, `pseudo_labels/masks/`ï¼‰
   - å¤‡ä»½ç›®å½•ç»“æ„ä¸å˜ï¼ˆ`backup/round_X/`ï¼‰
   - ç›‘æ§æ–‡ä»¶è·¯å¾„ä¸å˜ï¼ˆ`monitor/metrics_history.json`ï¼‰

2. **UNet è„šæœ¬**ï¼š
   - å¦‚æœä¸æ”¯æŒ `--pretrained_model`ï¼Œagent ä¼šæ­£å¸¸è¿è¡Œï¼ˆåªæ˜¯æ¯è½®ä»å¤´è®­ç»ƒï¼‰

---

## è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬è¿ç§»

#### 1. æ›´æ–°å‘½ä»¤è¡Œå‚æ•°
```bash
# æ—§ç‰ˆæœ¬
python agent.py \
  --sample-ratio 0.2 \
  --high-confidence 80.0

# æ–°ç‰ˆæœ¬
python agent.py \
  --samples-per-round 30 \
  --high-confidence 7.5
```

#### 2. è°ƒæ•´é«˜ç½®ä¿¡é˜ˆå€¼
```python
# æ—§ç‰ˆæœ¬é˜ˆå€¼ â†’ æ–°ç‰ˆæœ¬é˜ˆå€¼
90.0 â†’ 8.7  # å®Œç¾
80.0 â†’ 7.5  # ä¼˜ç§€ï¼ˆæ¨èï¼‰
70.0 â†’ 6.5  # è‰¯å¥½
60.0 â†’ 5.5  # ä¸­ç­‰
```

#### 3. å‡çº§ unet è„šæœ¬ï¼ˆå¯é€‰ï¼‰
åœ¨ unet è„šæœ¬ä¸­æ·»åŠ çƒ­å¯åŠ¨æ”¯æŒï¼š
```python
parser.add_argument("--pretrained-model", type=str, default=None)
args = parser.parse_args()

# æ¨¡å‹åˆå§‹åŒ–
model = smp.Unet(...)

# çƒ­å¯åŠ¨
if args.pretrained_model and Path(args.pretrained_model).exists():
    model.load_state_dict(torch.load(args.pretrained_model))
    print(f"[çƒ­å¯åŠ¨] ä» {args.pretrained_model} åŠ è½½æƒé‡")
```

#### 4. æ¸…ç†æ—§å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
æ—§ç‰ˆæœ¬çš„ `backup/*/scores.json` ä½¿ç”¨ 0-100 åˆ†åˆ¶ï¼Œä¸å…¼å®¹æ–°ç³»ç»Ÿï¼š
```bash
# å¤‡ä»½æ—§æ•°æ®
mv backup backup_old_version

# é‡æ–°å¼€å§‹
mkdir backup
```

---

## æ€§èƒ½å¯¹æ¯”

### æŠ½æ ·æ•ˆç‡
| æŒ‡æ ‡ | æ—§ç‰ˆæœ¬ï¼ˆç™¾åˆ†æ¯”ï¼‰ | æ–°ç‰ˆæœ¬ï¼ˆå›ºå®š30å¼ ï¼‰ |
|------|----------------|------------------|
| é¦–è½®æŠ½æ ·ï¼ˆ1000å¼ æ± ï¼‰ | 200å¼  | 30å¼  |
| ä¸­æœŸæŠ½æ ·ï¼ˆ500å¼ æ± ï¼‰ | 100å¼  | 30å¼  |
| åæœŸæŠ½æ ·ï¼ˆ50å¼ æ± ï¼‰ | 10å¼  | 30å¼  |
| APIè°ƒç”¨æˆæœ¬ | åŠ¨æ€ï¼ˆ10-200æ¬¡ï¼‰ | å›ºå®šï¼ˆæœ€å¤š30æ¬¡ï¼‰ |

### è¯„åˆ†ä¸¥æ ¼åº¦
| è´¨é‡æ°´å¹³ | æ—§ç‰ˆæœ¬å¾—åˆ† | æ–°ç‰ˆæœ¬å¾—åˆ† | å…¥é€‰æ¦‚ç‡å˜åŒ– |
|---------|-----------|-----------|------------|
| å®Œç¾åˆ†å‰² | 95+ | 8.7-8.9 | ç›¸å½“ |
| ä¼˜ç§€åˆ†å‰² | 85-95 | 7.5-8.6 | ç›¸å½“ |
| è‰¯å¥½åˆ†å‰² | 75-84 | 6.5-7.4 | **é™ä½**ï¼ˆæ›´ä¸¥æ ¼ï¼‰|
| ä¸­ç­‰åˆ†å‰² | 65-74 | 5.5-6.4 | **é™ä½** |

---

## æµ‹è¯•éªŒè¯

è¿è¡Œå‡çº§éªŒè¯è„šæœ¬ï¼š
```bash
python test_agent_upgrade.py
```

é¢„æœŸè¾“å‡ºï¼š
```
============================================================
æµ‹è¯•æ±‡æ€»
============================================================
é€šè¿‡: 5/5

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Agent.py å‡çº§æˆåŠŸï¼
```

---

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæ”¹ä¸ºå›ºå®š30å¼ ï¼Ÿ**
- ç¡®ä¿æ¯è½®APIè°ƒç”¨æˆæœ¬å¯æ§ï¼ˆæœ€å¤š30æ¬¡ï¼‰
- é¿å…åæœŸå‰©ä½™æ ·æœ¬è¿‡å°‘å¯¼è‡´æŠ½æ ·ä¸ç¨³å®š
- æé«˜å¯å¤ç°æ€§ï¼ˆrandom.seed(round_num)ï¼‰

**Q: ä¸ºä»€ä¹ˆè¯„åˆ†èŒƒå›´æ”¹ä¸º0-10ï¼Ÿ**
- 0-100 åˆ†åˆ¶å®¹æ˜“å¯¼è‡´"åˆ†æ•°é€šèƒ€"ï¼ˆå¤§é‡90+ï¼‰
- 0-10 åˆ†åˆ¶æ›´ç¬¦åˆå­¦æœ¯è¯„åˆ†ä¹ æƒ¯
- æä¸¥è‹›æ ‡å‡†ï¼ˆæœ€é«˜8.9ï¼‰ç¡®ä¿å…¥é€‰æ ·æœ¬é«˜è´¨é‡

**Q: çƒ­å¯åŠ¨ä¼šè¿‡æ‹Ÿåˆå—ï¼Ÿ**
- å­¦ä¹ ç‡é€’å‡ï¼ˆ0.8^roundï¼‰ç¼“è§£è¿‡æ‹Ÿåˆ
- ä¼ªæ ‡ç­¾é›†åŠ¨æ€æ›´æ–°ï¼ˆFIFO 5000å¼ ï¼‰
- æµ‹è¯•é›†æŒç»­ç›‘æ§ï¼Œé¿å…æ€§èƒ½ä¸‹é™

**Q: å¦‚æœunetä¸æ”¯æŒçƒ­å¯åŠ¨ï¼Ÿ**
- agent ä»èƒ½æ­£å¸¸è¿è¡Œï¼Œåªæ˜¯æ¯è½®ä»å¤´è®­ç»ƒ
- å»ºè®®å‡çº§ unet è„šæœ¬ä»¥è·å¾—æœ€ä½³æ€§èƒ½

---

## ç›¸å…³æ–‡ä»¶

- **å‡çº§åä»£ç **: `agent.py`
- **è¯¦ç»†è¯´æ˜**: `AGENT_UPGRADE_README.md`
- **å˜æ›´æ—¥å¿—**: `UPGRADE_CHANGELOG.md`ï¼ˆæœ¬æ–‡æ¡£ï¼‰
- **æµ‹è¯•è„šæœ¬**: `test_agent_upgrade.py`
- **è¿è¡Œç¤ºä¾‹**: `run_agent_example.sh`

---

## ç‰ˆæœ¬æ ‡è¯†

åœ¨ä»£ç ä¸­æŸ¥æ‰¾ä»¥ä¸‹æ ‡è¯†ç¡®è®¤å‡çº§ç‰ˆæœ¬ï¼š
```python
# agent.py ç¬¬32è¡Œ
SYSTEM_PROMPT = """ä½ æ˜¯é¡¶å°–åŒ»å­¦å›¾åƒåˆ†å‰²è´¨æ£€AIï¼Œä»»åŠ¡æ˜¯å¯¹é¢„æµ‹æ©ç è¿›è¡Œ **0.0â€“10.0 è¯„åˆ†ï¼ˆä¿ç•™1ä½å°æ•°ï¼Œç¦æ­¢ç»™ 9.0 åŠä»¥ä¸Šï¼‰**ã€‚

# agent.py ç¬¬825è¡Œé™„è¿‘
random.seed(round_num)  # ä¿è¯å¯å¤ç°
sample_size = min(args.samples_per_round, len(available_images))

# agent.py ç¬¬719è¡Œé™„è¿‘
lr = args.lr * (0.8 ** round_num)
```

---

**å‡çº§å®Œæˆï¼ğŸ‰**
